#!/usr/bin/with-contenv bashio

# Get configuration
URI=$(bashio::config 'uri')
DEVICE=$(bashio::config 'device')
DEBUG=$(bashio::config 'debug')
MODEL_REPO=$(bashio::config 'model_repo')

# Set log level
if [ "$DEBUG" = "true" ]; then
    LOG_LEVEL="--debug"
else
    LOG_LEVEL=""
fi

bashio::log.info "Starting Wyoming Arabic ASR server..."
bashio::log.info "Model repository: $MODEL_REPO"
bashio::log.info "URI: $URI"
bashio::log.info "Device: $DEVICE"

# Create cache directory
mkdir -p /share/arabic_asr_cache

# Start the server with auto-download
cd /app
exec python3 arabic_asr.py \
    --model-repo "$MODEL_REPO" \
    --cache-dir "/share/arabic_asr_cache" \
    --uri "$URI" \
    --device "$DEVICE" \
    $LOG_LEVEL